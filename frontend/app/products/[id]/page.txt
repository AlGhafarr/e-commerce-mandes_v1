'use client';

import React, { useState } from 'react';
import { Star, Minus, Plus, ShoppingCart, Heart, Share2, MapPin, Truck, ShieldCheck, ChevronRight, MessageCircle, X, CheckCircle } from 'lucide-react';
import Header from '@/components/Header'; // Pastikan path header sesuai
import Footer from '@/components/Footer'; // Pastikan path footer sesuai
import Link from 'next/link';

// --- DUMMY DATA PRODUCT (Simulasi Data Database) ---
const PRODUCT = {
  id: 1,
  name: "Keripik Singkong Balado Pedas Nampol Level 5",
  price: 15000,
  originalPrice: 20000,
  rating: 4.8,
  reviews_count: 128,
  sold: 1200,
  description: "Rasakan sensasi pedas nampol dari keripik singkong pilihan! Dibuat dari singkong madu berkualitas yang diiris tipis, digoreng renyah, dan dibalut bumbu balado rahasia turun temurun. Cocok untuk teman nonton drakor atau nugas.\n\nKomposisi: Singkong, Cabai, Bawang, Garam, Gula, Penyedap Rasa.\nBerat Bersih: Sesuai Varian.",
  store: {
    name: "Mandes Official Store",
    location: "Jakarta Selatan",
    avatar: "SN"
  },
  images: [
    "https://placehold.co/600x600/F87B1B/white?text=Keripik+Balado+1",
    "https://placehold.co/600x600/orange/white?text=Detail+Tekstur",
    "https://placehold.co/600x600/FF9F4A/white?text=Kemasan+Belakang",
    "https://placehold.co/600x600/F87B1B/white?text=Saran+Penyajian",
  ],
  variants: ["Pedas Level 1", "Pedas Level 3", "Pedas Level 5"],
  sizes: ["100gr", "250gr", "500gr"],
  shipping: {
    origin: "Jakarta Selatan",
    estimation: "2-3 Hari",
    cost: 9000
  },
  reviews: [
    { user: "Budi Santoso", rating: 5, comment: "Pedasnya nampol banget! Keripiknya renyah gak keras.", date: "2 hari lalu" },
    { user: "Siti Aminah", rating: 4, comment: "Enak, cuma pengiriman agak lama sedikit.", date: "1 minggu lalu" }
  ]
};

export default function ProductDetail() {
  // --- STATE ---
  const [activeImage, setActiveImage] = useState(0);
  
  // State Pilihan User
  const [selectedVariant, setSelectedVariant] = useState(PRODUCT.variants[2]); // Default Level 5
  const [selectedSize, setSelectedSize] = useState(PRODUCT.sizes[1]); // Default 250gr
  const [quantity, setQuantity] = useState(1);
  const [isWishlist, setIsWishlist] = useState(false);

  // State UI (Modal & Toast)
  const [isMobileModalOpen, setIsMobileModalOpen] = useState(false);
  const [showToast, setShowToast] = useState(false);
  const [toastMessage, setToastMessage] = useState("");

  // --- LOGIC ---
  const handleQuantity = (type: 'inc' | 'dec') => {
    if (type === 'inc') setQuantity(q => q + 1);
    if (type === 'dec' && quantity > 1) setQuantity(q => q - 1);
  };

  const totalPrice = PRODUCT.price * quantity;

  // Fungsi Menampilkan Toast Custom (Bukan Alert Browser)
  const triggerToast = (msg: string) => {
    setToastMessage(msg);
    setShowToast(true);
    setTimeout(() => setShowToast(false), 3000); // Hilang otomatis 3 detik
  };

  // Handler Checkout / Cart
  const handleAddToCart = () => {
    setIsMobileModalOpen(false); // Tutup modal jika di mobile
    triggerToast(`Berhasil masuk keranjang!\n${quantity}x ${selectedVariant} (${selectedSize})`);
  };

  const handleBuyNow = () => {
    setIsMobileModalOpen(false);
    triggerToast("Mengalihkan ke halaman Checkout...");
    // Di sini nanti redirect ke halaman checkout
  };

  return (
    <div className="min-h-screen bg-[#FCF9EA] pb-24 lg:pb-0 relative">
      <Header />

      {/* --- CUSTOM TOAST NOTIFICATION (Pop-up Alert) --- */}
      <div className={`fixed top-24 left-1/2 -translate-x-1/2 z-[60] transition-all duration-300 transform ${showToast ? 'translate-y-0 opacity-100' : '-translate-y-10 opacity-0 pointer-events-none'}`}>
        <div className="bg-gray-800 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 min-w-[300px]">
          <CheckCircle size={24} className="text-green-400" />
          <div>
            <h4 className="font-bold text-sm">Sukses!</h4>
            <p className="text-xs text-gray-300 whitespace-pre-line">{toastMessage}</p>
          </div>
        </div>
      </div>

      <main className="container mx-auto px-4 py-4 lg:py-8">
        
        {/* Breadcrumb */}
        <div className="text-xs text-gray-500 mb-4 flex items-center gap-1">
          <Link href="/" className="hover:text-[#F87B1B]">Beranda</Link> 
          <ChevronRight size={12} /> 
          <Link href="/products" className="hover:text-[#F87B1B]">Katalog</Link>
          <ChevronRight size={12} />
          <span className="text-gray-800 font-medium truncate max-w-[150px]">{PRODUCT.name}</span>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          
          {/* --- KOLOM KIRI: GALERI FOTO --- */}
          <div className="lg:col-span-5">
            <div className="sticky top-24 space-y-4">
              {/* Main Image */}
              <div className="aspect-square bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 relative group">
                <img 
                  src={PRODUCT.images[activeImage]} 
                  alt="Product" 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" 
                />
                <div className="absolute bottom-4 right-4 bg-black/50 text-white text-xs px-2 py-1 rounded-full lg:hidden">
                  {activeImage + 1}/{PRODUCT.images.length}
                </div>
              </div>

              {/* Thumbnails */}
              <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
                {PRODUCT.images.map((img, idx) => (
                  <button 
                    key={idx}
                    onClick={() => setActiveImage(idx)}
                    className={`flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border-2 transition-all ${activeImage === idx ? 'border-[#F87B1B] opacity-100' : 'border-transparent opacity-60 hover:opacity-100'}`}
                  >
                    <img src={img} className="w-full h-full object-cover" />
                  </button>
                ))}
              </div>
            </div>
          </div>

          {/* --- KOLOM TENGAH: INFO PRODUK --- */}
          <div className="lg:col-span-4 space-y-6">
            
            {/* Header Info */}
            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
              <div className="flex justify-between items-start">
                <h1 className="text-xl lg:text-2xl font-bold text-gray-800 leading-snug">{PRODUCT.name}</h1>
                <button onClick={() => setIsWishlist(!isWishlist)} className="p-2 rounded-full hover:bg-gray-50 text-gray-400">
                  <Heart fill={isWishlist ? "#ef4444" : "none"} className={isWishlist ? "text-red-500" : ""} />
                </button>
              </div>

              <div className="flex items-end gap-2 mt-3">
                <span className="text-2xl lg:text-3xl font-bold text-[#F87B1B]">Rp {PRODUCT.price.toLocaleString('id-ID')}</span>
                <span className="text-gray-400 line-through text-sm mb-1">Rp {PRODUCT.originalPrice.toLocaleString('id-ID')}</span>
              </div>

              <div className="flex items-center gap-3 mt-3 text-sm border-t border-gray-50 pt-3">
                <div className="flex items-center gap-1 text-yellow-500">
                  <Star fill="currentColor" size={16} />
                  <span className="font-bold text-gray-800">{PRODUCT.rating}</span>
                  <span className="text-gray-400">({PRODUCT.reviews_count} Ulasan)</span>
                </div>
                <span className="text-gray-300">|</span>
                <div className="text-gray-600">Terjual <span className="font-bold text-gray-800">{PRODUCT.sold}+</span></div>
              </div>
            </div>

            {/* Varian & Ukuran (Preview Statis di Mobile, Input Aktif di Desktop) */}
            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-5">
              {/* Varian */}
              <div>
                <h3 className="font-bold text-gray-700 mb-3">Pilih Varian:</h3>
                <div className="flex flex-wrap gap-2">
                  {PRODUCT.variants.map((variant) => (
                    <button 
                      key={variant}
                      onClick={() => setSelectedVariant(variant)}
                      className={`px-4 py-2 rounded-lg text-sm border transition-all ${selectedVariant === variant ? 'bg-orange-50 border-[#F87B1B] text-[#F87B1B] font-bold' : 'border-gray-200 text-gray-600 hover:border-gray-300'}`}
                    >
                      {variant}
                    </button>
                  ))}
                </div>
              </div>

              {/* Ukuran */}
              <div>
                <h3 className="font-bold text-gray-700 mb-3">Pilih Ukuran:</h3>
                <div className="flex flex-wrap gap-2">
                  {PRODUCT.sizes.map((size) => (
                    <button 
                      key={size}
                      onClick={() => setSelectedSize(size)}
                      className={`px-4 py-2 rounded-lg text-sm border transition-all ${selectedSize === size ? 'bg-orange-50 border-[#F87B1B] text-[#F87B1B] font-bold' : 'border-gray-200 text-gray-600 hover:border-gray-300'}`}
                    >
                      {size}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            {/* Deskripsi & Pengiriman */}
            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-4">
              <div>
                <h3 className="font-bold text-gray-800 mb-2">Detail Pengiriman</h3>
                <div className="flex items-center gap-3 text-sm text-gray-600 bg-gray-50 p-3 rounded-xl">
                  <Truck size={20} className="text-[#F87B1B]" />
                  <div>
                    <p>Dikirim dari <span className="font-bold">{PRODUCT.shipping.origin}</span></p>
                    <p className="text-xs text-gray-500">Estimasi tiba {PRODUCT.shipping.estimation} â€¢ Ongkir Rp {PRODUCT.shipping.cost.toLocaleString('id-ID')}</p>
                  </div>
                </div>
              </div>
              
              <div className="pt-4 border-t border-gray-100">
                <h3 className="font-bold text-gray-800 mb-2">Deskripsi Produk</h3>
                <p className="text-sm text-gray-600 leading-relaxed whitespace-pre-line">{PRODUCT.description}</p>
              </div>
            </div>

            {/* Ulasan (Preview) */}
            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 className="font-bold text-gray-800 mb-4">Ulasan Pembeli</h3>
                <div className="space-y-4">
                    {PRODUCT.reviews.map((rev, idx) => (
                        <div key={idx} className="border-b border-gray-100 pb-3 last:border-0 last:pb-0">
                            <div className="flex items-center justify-between mb-1">
                                <span className="font-bold text-sm text-gray-700">{rev.user}</span>
                                <span className="text-xs text-gray-400">{rev.date}</span>
                            </div>
                            <div className="flex text-yellow-400 mb-1">
                                {[...Array(5)].map((_, i) => <Star key={i} size={12} fill={i < rev.rating ? "currentColor" : "none"} className={i >= rev.rating ? "text-gray-200" : ""} />)}
                            </div>
                            <p className="text-xs text-gray-600">{rev.comment}</p>
                        </div>
                    ))}
                </div>
            </div>

          </div>

          {/* --- KOLOM KANAN: STICKY ACTION CARD (Desktop Only) --- */}
          <div className="hidden lg:block lg:col-span-3">
            <div className="sticky top-24 bg-white p-5 rounded-2xl shadow-lg border border-gray-100">
              <h3 className="font-bold text-gray-800 mb-4">Atur Jumlah</h3>
              
              {/* Preview Pilihan */}
              <div className="mb-4 text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">
                <p>Varian: <span className="font-bold text-gray-800">{selectedVariant}</span></p>
                <p>Ukuran: <span className="font-bold text-gray-800">{selectedSize}</span></p>
              </div>

              {/* Quantity Input */}
              <div className="flex items-center gap-3 mb-6">
                <div className="flex items-center border border-gray-200 rounded-lg w-full justify-between px-2 py-1">
                  <button onClick={() => handleQuantity('dec')} disabled={quantity <= 1} className="p-2 hover:bg-gray-100 disabled:opacity-50 text-gray-600">
                    <Minus size={16} />
                  </button>
                  <input type="text" value={quantity} readOnly className="w-12 text-center text-sm font-bold text-gray-800 outline-none" />
                  <button onClick={() => handleQuantity('inc')} className="p-2 hover:bg-gray-100 text-[#F87B1B]">
                    <Plus size={16} />
                  </button>
                </div>
              </div>

              <div className="flex justify-between items-center mb-6">
                <span className="text-gray-600 text-sm">Subtotal</span>
                <span className="text-xl font-bold text-[#F87B1B]">Rp {totalPrice.toLocaleString('id-ID')}</span>
              </div>

              <div className="space-y-3">
                <button onClick={handleAddToCart} className="w-full bg-[#F87B1B] text-white py-3 rounded-xl font-bold hover:shadow-orange-300 hover:shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2">
                  <ShoppingCart size={18} /> + Keranjang
                </button>
                <button onClick={handleBuyNow} className="w-full bg-white border border-[#F87B1B] text-[#F87B1B] py-3 rounded-xl font-bold hover:bg-orange-50 transition-all active:scale-95">
                  Beli Langsung
                </button>
              </div>

              <div className="mt-4 pt-4 border-t border-gray-100 flex justify-center gap-4 text-gray-500 text-xs font-medium">
                <span className="flex items-center gap-1"><ShieldCheck size={14} /> Aman & Terpercaya</span>
              </div>
            </div>
          </div>

        </div>
      </main>

      {/* --- MOBILE BOTTOM ACTION BAR (Sticky) --- */}
      <div className="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 z-40 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
        <div className="flex gap-3 items-center">
          <button className="p-3 border border-gray-200 rounded-xl text-gray-500 hover:bg-gray-50">
            <MessageCircle size={20} />
          </button>
          <div className="flex-1 flex gap-2">
            <button 
              onClick={() => setIsMobileModalOpen(true)} // Buka Pop-up
              className="flex-1 bg-orange-50 border border-[#F87B1B] text-[#F87B1B] py-3 rounded-xl font-bold text-sm"
            >
              + Keranjang
            </button>
            <button 
              onClick={() => setIsMobileModalOpen(true)} // Buka Pop-up
              className="flex-1 bg-[#F87B1B] text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-orange-200"
            >
              Beli Sekarang
            </button>
          </div>
        </div>
      </div>

      {/* --- MOBILE BOTTOM SHEET MODAL (POP-UP INPUT) --- */}
      {/* Overlay Gelap */}
      <div 
        className={`fixed inset-0 bg-black/60 z-50 transition-opacity duration-300 lg:hidden ${isMobileModalOpen ? 'opacity-100 visible' : 'opacity-0 invisible'}`} 
        onClick={() => setIsMobileModalOpen(false)}
      />
      
      {/* Konten Modal */}
      <div className={`fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl z-[55] p-5 shadow-2xl transition-transform duration-300 lg:hidden ${isMobileModalOpen ? 'translate-y-0' : 'translate-y-full'}`}>
        
        {/* Header Modal & Close */}
        <div className="flex gap-4 mb-6 border-b border-gray-100 pb-4">
            <div className="w-24 h-24 rounded-xl bg-gray-100 overflow-hidden flex-shrink-0 border border-gray-200">
                <img src={PRODUCT.images[0]} className="w-full h-full object-cover" />
            </div>
            <div className="flex-1 relative pt-1">
                <button onClick={() => setIsMobileModalOpen(false)} className="absolute top-0 right-0 text-gray-400"><X size={24}/></button>
                <div className="pr-6">
                    <p className="font-bold text-lg text-[#F87B1B] mb-1">Rp {totalPrice.toLocaleString('id-ID')}</p>
                    <p className="text-xs text-gray-500">Stok: 50+ pcs</p>
                </div>
            </div>
        </div>

        {/* Scrollable Content di Modal */}
        <div className="max-h-[50vh] overflow-y-auto space-y-6 pb-20 scrollbar-hide">
            {/* Input Varian (Mobile) */}
            <div>
                <h3 className="font-bold text-gray-800 mb-3 text-sm">Pilih Varian</h3>
                <div className="flex flex-wrap gap-2">
                    {PRODUCT.variants.map((v) => (
                    <button key={v} onClick={() => setSelectedVariant(v)} className={`px-4 py-2 rounded-full text-sm border ${selectedVariant === v ? 'bg-[#F87B1B] text-white border-[#F87B1B]' : 'bg-white text-gray-600 border-gray-200'}`}>
                        {v}
                    </button>
                    ))}
                </div>
            </div>

            {/* Input Ukuran (Mobile) */}
            <div>
                <h3 className="font-bold text-gray-800 mb-3 text-sm">Pilih Ukuran</h3>
                <div className="flex flex-wrap gap-2">
                    {PRODUCT.sizes.map((s) => (
                    <button key={s} onClick={() => setSelectedSize(s)} className={`px-4 py-2 rounded-full text-sm border ${selectedSize === s ? 'bg-[#F87B1B] text-white border-[#F87B1B]' : 'bg-white text-gray-600 border-gray-200'}`}>
                        {s}
                    </button>
                    ))}
                </div>
            </div>

            {/* Input Jumlah (Mobile) */}
            <div className="flex justify-between items-center py-4 border-t border-gray-100">
                <span className="font-bold text-gray-800 text-sm">Jumlah</span>
                <div className="flex items-center border border-gray-200 rounded-full bg-gray-50 px-2 py-1">
                  <button onClick={() => handleQuantity('dec')} disabled={quantity <= 1} className="p-2 hover:bg-gray-200 rounded-full disabled:opacity-50 text-gray-600"><Minus size={16} /></button>
                  <input type="text" value={quantity} readOnly className="w-10 text-center text-sm font-bold bg-transparent outline-none" />
                  <button onClick={() => handleQuantity('inc')} className="p-2 hover:bg-gray-200 rounded-full text-[#F87B1B]"><Plus size={16} /></button>
                </div>
            </div>
        </div>

        {/* Tombol Konfirmasi Akhir (Sticky di Modal) */}
        <div className="absolute bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-100">
            <button onClick={handleAddToCart} className="w-full bg-[#F87B1B] text-white py-3 rounded-xl font-bold shadow-lg shadow-orange-200">
                Masukkan Keranjang - Rp {totalPrice.toLocaleString('id-ID')}
            </button>
        </div>
      </div>

      <div className="hidden lg:block">
        <Footer />
      </div>
    </div>
  );
}